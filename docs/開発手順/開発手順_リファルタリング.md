

---

### **📘 開発手順書（Phase 1-3: リファクタリング編）**

今回の「バックエンドの構造化」の作業内容をまとめたドキュメントです。  
将来、機能を追加する際は、この構造（Routes \-\> Controllers \-\> Services）に従ってコードを書くことになります。

Markdown

\# 📘 メモアプリ開発手順書 (Phase 1-3: バックエンド・リファクタリング)

本フェーズでは、「関心の分離 (Separation of Concerns)」に基づき、肥大化した \`index.ts\` を役割ごとのレイヤーに分割・整理した。

\#\# 📂 1\. ディレクトリ構成の変更

\`backend/src/\` フォルダを作成し、以下のように役割分担を行った。

\* **\*\*routes/\*\***: URLと処理の紐付け（道案内）  
\* **\*\*controllers/\*\***: リクエストの検証とレスポンスの返却（司令塔）  
\* **\*\*services/\*\***: データベース操作などのビジネスロジック（実作業）  
\* **\*\*utils/\*\***: 共通ツール（Prismaクライアントなど）

\#\# 🛠️ 2\. 実装詳細

\#\#\# **\*\*2.1 Utils層 (\`utils/prismaClient.ts\`)\*\***  
\* \`PrismaClient\` のインスタンスを1つ生成し、アプリ全体で使い回すように共通化。

\#\#\# **\*\*2.2 Services層 (\`services/memoService.ts\`)\*\***  
\* Prisma を使って DB を操作する関数群（\`findMany\`, \`create\`, \`update\`, \`delete\`）を定義。  
\* Express (\`req\`, \`res\`) に依存しない純粋な関数として実装。

\#\#\# **\*\*2.3 Controllers層 (\`controllers/memoController.ts\`)\*\***  
\* クライアントからのリクエスト (\`req\`) を受け取る。  
\* 必要なデータを取り出し、バリデーション（入力チェック）を行う。  
\* Service層の関数を呼び出し、その結果をレスポンス (\`res\`) として返す。  
\* エラーハンドリング（\`try-catch\`）を一括して行う。

\#\#\# **\*\*2.4 Routes層 (\`routes/memoRoutes.ts\`)\*\***  
\* Expressの \`Router\` を使用。  
\* URL (\`/\`, \`/:id\`) と Controller の関数を紐付ける定義のみを記述。

\#\#\# **\*\*2.5 エントリーポイント (\`index.ts\`)\*\***  
\* サーバー設定（CORS, JSONパース）とルーティングの登録のみに簡素化。  
\* \`app.use('/memos', memoRoutes)\` でルーティングを委譲。

\#\# 🚑 3\. トラブルシューティング

\#\#\# **\*\*VS Code の型エラー (\`Cannot find module...\`)\*\***  
Dev Container で開発している場合でも、バックエンドのライブラリ情報がホスト（Mac）側と同期されていないと、VS Code が認識できずにエラーが出る。

**\*\*解決策:\*\***  
Macのターミナルで以下を実行し、バックエンドの \`node\_modules\` を同期させる。  
\`\`\`bash  
docker compose run \--rm backend npm install  
docker compose run \--rm backend npm install \-D @types/express @types/cors

### **サーバー再起動 (Server is running...)**

ts-node はファイルを書き換えても自動で再起動しないため、変更を反映させるには手動再起動が必要。

Bash

docker compose restart backend

## **🎉 4\. 成果**

* コードの見通しが良くなり、チーム開発での競合リスクが減少した。  
* 機能追加（例: ユーザー認証、バリデーション）を差し込む場所が明確になった。  
* APIの動作（フロントエンドからの利用）は変更前と完全に同じ状態を維持できた。

\---

\#\#\# 🚀 次のステップ

これでコードがきれいになり、さらに機能を追加しやすくなりました。  
ロードマップに従うと、次は \*\*「1-4. 環境変数の管理 (.env) の徹底」\*\* や \*\*「1-5. バリデーション (Zod) の導入」\*\* です。

セキュリティや堅牢性を高めるフェーズですが、進めますか？  
