

# ---

**📘 開発手順書 (v1.2): Render & Supabase デプロイ完全ガイド**

Project: Simple Memo App (Backend)  
Last Updated: 2025-12-06  
Version: 1.2 (Stable Deployment Edition)  
本ドキュメントは、ローカル開発環境（Dev Containers）から Render（本番環境）へバックエンドをデプロイし、Supabase Storage と連携させるための設定およびトラブルシューティングの全記録である。

## ---

**1\. 環境設定 (Environment Setup)**

### **1.1 Render 環境変数 (Environment Variables)**

RenderのDashboardにて以下の変数を設定し、Supabaseへの接続とビルドを制御する。

| 変数名 | 設定値 / 形式 | 役割 |
| :---- | :---- | :---- |
| AWS\_ACCESS\_KEY\_ID | (Supabase S3 Access Key) | ストレージ接続用認証ID |
| AWS\_SECRET\_ACCESS\_KEY | (Supabase S3 Secret Key) | ストレージ接続用秘密鍵 |
| AWS\_ENDPOINT | https://\[ProjectID\].supabase.co/storage/v1/s3 | SupabaseのS3互換エンドポイント |
| AWS\_BUCKET\_NAME | images (等) | 保存先のバケットID |
| AWS\_REGION | ap-northeast-2 | Supabaseのリージョン |
| NODE\_VERSION | 20 | ビルド環境のNode.jsバージョン固定 |
| NPM\_CONFIG\_PRODUCTION | false | devDependencies (TypeScript等) をインストールさせるために必須 |

### **1.2 Dockerfile 設定**

Renderのメモリ制限対策およびPrismaの動作保証のため、以下の構成を採用。

* **Base Image:** node:20-slim (軽量化)  
* **Dependencies:** openssl をインストール (Prisma接続に必須)  
* **Command:** CMD \["node", "dist/index.js"\] (コンパイル済みのJSを実行)

## ---

**2\. コードベース修正 (Critical Code Fixes)**

デプロイ後に発生した「保存できない」「エラーが出る」問題を解決するための重要な修正箇所。

### **🛠️ 2.1 バックエンド・エントリーポイント (index.ts)**

* **CORSの柔軟化:**  
  * ローカル開発でポート番号が変わる（5173 \-\> 5174）問題に対応するため、正規表現または前方一致ロジックで http://localhost:\* を許可。  
  * 本番フロントエンドのURLも許可リストに追加。  
* **ログ出力の強化:**  
  * リクエストの到達確認のため、app.use('\*', ...) でメソッド・URL・Originをログ出力する「検問」を設置。

### **🛠️ 2.2 画像アップロードロジック (memoController.ts)**

Node.js環境（サーバーサイド）特有の挙動に対応するための修正。

1. **ダックタイピング (Duck Typing) の導入:**  
   * **問題:** instanceof File はNode.js環境で正しく判定されない場合がある。  
   * **解決:** 「オブジェクトであり、かつ arrayBuffer 関数を持っているか」でファイルかどうかを判定するロジックに変更。  
2. **ファイル名のサニタイズ (Sanitization):**  
   * **問題:** 日本語ファイル名やスペースを含むファイルをアップロードすると、Supabase (S3) が InvalidKey エラーを返す。  
   * **解決:** ファイル名をそのまま使わず、Date.now() \+ ランダム英数字 \+ 拡張子 に強制変換して保存する。

### **🛠️ 2.3 ルーティング定義 (routes/memoRoutes.ts)**

* **Import/Exportの統一:**  
  * ビルドエラーを防ぐため、export default app と import memoRoutes from ... の形式に統一。

## ---

**3\. ビルド & デプロイ戦略 (Build Strategy)**

Render上でのビルドは時間がかかり、タイムアウトやメモリ不足の原因となるため、\*\*「ローカルビルド・プッシュ方式」\*\*を正式なフローとする。

### **✅ デプロイ手順フロー**

コードを修正した後、以下の手順でデプロイを行うこと。

1. **ローカルでビルドを実行**  
   Bash  
   cd backend  
   npm run build  
   \# これにより、最新のコードが dist/ フォルダに生成される

2. 成果物 (dist) をGitに強制追加  
   通常 dist は .gitignore 対象だが、Renderで動かすために強制的にコミットする。  
   Bash  
   git add \-f dist  
   git add src/ (修正したソースコードも含む)  
   git commit \-m "Update build artifacts for deployment"

3. **リモートへプッシュ**  
   Bash  
   git push origin feature/aws-infrastructure

4. **Renderでの確認**  
   * Dashboardでデプロイが Live になるのを待つ。  
   * ブラウザで https://\[your-backend\].onrender.com/ にアクセスし、バージョン情報などが表示されるか確認する。

## ---

**4\. トラブルシューティングログ (Known Issues)**

| 現象 | 原因 | 対処法 |
| :---- | :---- | :---- |
| **ブラウザで 404 Not Found (URL重複)** | フロントエンドの API\_BASE\_URL が /api/memos まで含んでいたため、/api/memos/memos になっていた。 | memoApi.ts のBase URL末尾の /memos を削除する。 |
| **ログが出ない / コードが反映されない** | src だけ修正して dist を更新せずにプッシュしていたため、古いビルドが動いていた。 | 上記「デプロイ手順フロー」に従い、必ず npm run build をしてからプッシュする。 |
| **画像保存失敗 (ログなし / 201 OK)** | instanceof File が偽となり、アップロード処理がスキップされていた。 | ダックタイピング判定に変更する。 |
| **画像保存失敗 (InvalidKey Error)** | ファイル名に日本語が含まれていた。 | コントローラーでファイル名をランダム英数字に変換する処理を追加。 |
| **CORS Error (Network Error)** | フロントエンドのポートが 5174 に変わっていたが、許可リストになかった。 | index.ts のCORS設定で origin.startsWith("http://localhost:") を許可する。 |

---

Next Step:  
このバックエンド環境が安定したため、次はフロントエンドのRenderへのデプロイ（Static Site）を行い、完全なWebアプリとして公開を目指す。