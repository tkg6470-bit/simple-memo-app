# ---

**📘 開発手順書: メモ編集機能 (F-04) 実装ガイド**

プロジェクト: Simple Memo App (Ultimate Edition)  
バージョン: v2.3.0  
対象機能: 既存メモのタイトル・本文・画像の更新 (CRUDの Update)

## ---

**1\. バックエンド実装 (API)**

Hono RPC と Prisma を使用し、更新用の PUT エンドポイントを作成します。

### **1.1 ルーティング定義 (backend/src/routes/memoRoutes.ts)**

* **メソッド:** PUT /:id  
* **バリデーション:** Zodを使用。  
  * **重要:** 画像ファイル (File型) のバリデーションは環境によって不安定になることがあるため、厳格な z.instanceof(File) ではなく **z.any().optional()** を採用し、ロジック内で型チェックを行う。  
* **処理フロー:**  
  1. **所有権チェック:** auth.userId と DBの userId が一致するか確認。  
  2. **画像処理:** 画像が送信された場合のみ、Storage (MinIO/Supabase) へアップロードしURLを更新。  
  3. **DB更新:** prisma.memo.update を実行。  
  4. **ベクトル更新:** タイトル・本文が変更されたため、OpenAI Embedding を再生成して保存。

TypeScript

// バリデーション例 (安定版)  
const updateMemoSchema \= z.object({  
  title: z.string().min(1),  
  content: z.string().min(1),  
  image: z.any().optional(), // 緩い型定義でエラー回避  
});

## ---

**2\. フロントエンド実装 (UI/UX)**

React で編集用のモーダルを作成し、Hono Client で API を呼び出します。

### **2.1 編集モーダル (frontend/src/components/EditMemoModal.tsx)**

* **デザイン:** 既存のCSS設定に依存せず確実に表示させるため、**インラインスタイル (style={{...}})** を採用。  
* **機能:** タイトル、本文、画像（任意）の入力フォーム。  
* **制御:** isOpen Props で表示/非表示を制御。

### **2.2 状態管理と統合 (frontend/src/App.tsx)**

* **State:** editingMemo (編集対象のメモデータ) と isEditModalOpen (モーダル開閉フラグ) を追加。  
* **APIコール:** client.api.memos\[":id"\].$put を使用してデータを送信。  
* **更新後:** loadMemos() を呼び出し、画面リストを最新化。

## ---

**3\. インフラ・デプロイ (Render/CI)**

ローカル環境 (Mac/Windows) と 本番環境 (Linux) の差異を吸収する設定を行います。

### **3.1 クロスプラットフォーム対応 (Build Fix)**

Render (Linux) でビルドエラーが発生する場合、以下の OS 固有パッケージを追加インストールする必要があります。

**発生したエラー:**

* Cannot find module '@rollup/rollup-linux-x64-gnu'  
* The package "@esbuild/linux-x64" could not be found

**解決コマンド:**

Bash

cd frontend  
npm install \--save-optional @rollup/rollup-linux-x64-gnu @esbuild/linux-x64

これにより package-lock.json に Linux 用の依存関係が記録され、Render でのビルドが成功します。

## ---

**4\. トラブルシューティング事例 (Lessons Learned)**

今回の開発で発生した問題と解決策のまとめです。

| 分類 | 現象 | 原因 | 解決策 |
| :---- | :---- | :---- | :---- |
| **Deploy** | Renderでのデプロイ失敗 (赤文字エラー) | ローカル(Mac/Win)と本番(Linux)で必要なビルドツール(Rollup/Esbuild)が異なる。 | Linux用パッケージを optional として追加インストール。 |
| **UI** | 編集ボタンを押しても画面に何も出ない | Tailwind CSS の設定不備または適用漏れにより、モーダルのサイズが0になっていた。 | 確実性を優先し、モーダルコンポーネントをインラインスタイルで書き直した。 |
| **API** | 更新時に "Failed to update" エラー | Zodの z.instanceof(File) が、HTTPリクエスト経由のデータを正しく認識できず弾いていた。 | z.any() に緩和し、コード内で if (image && 'name' in image) のように手動チェックに変更。 |

## ---

**5\. 今後の開発への引き継ぎ**

* **Git運用:**  
  * 機能修正時は git add . \-\> git commit \-m "fix: ..." \-\> git push のフローを徹底する。  
* **次回タスク:**  
  * これで「インフラ」「型安全」「基本機能」が完成しました。  
  * 次はロードマップに基づき、コードの整理や、さらなる機能拡張（例：タグ機能、共有機能など）へ進めます。

---

このドキュメントを保存しておくと、将来「あれ、デプロイが落ちたぞ？」といった時にすぐに解決策を思い出せます！素晴らしい開発でした！