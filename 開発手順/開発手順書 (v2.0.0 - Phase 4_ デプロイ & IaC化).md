

# ---

**📘 開発手順書 (v2.0.0 \- Phase 4: デプロイ & IaC化)**

## **1\. インフラのコード化 (IaC)**

Renderの管理画面での手動設定を廃止し、render.yaml による自動構築を採用しました。

* **ファイル:** render.yaml  
* **構成:**  
  * **Backend:** DockerベースのWebサービス。  
  * **Frontend:** Node.jsベースのWebサービス（Static Siteとして設定）。  
  * **Database:** 外部サービス（Supabase）を使用。  
* **ポイント:**  
  * dockerContext をルートに設定し、モノレポ構造に対応。  
  * 環境変数グループ (shared-secrets) を定義し、機密情報をコードから分離。

## **2\. バックエンド構築手順 (Docker & Prisma)**

Render上で正しく起動し、DB接続を自動化するための設定です。

### **2-1. Dockerfile の最適化**

* **ファイル:** backend/Dockerfile  
* **修正内容:**  
  1. **ビルドプロセスの追加:** npm run build を実行し、TypeScript を JavaScript (dist/) に変換。  
  2. **依存関係:** openssl をインストール（Prismaに必須）。  
  3. **起動コマンド:** 以下のコマンドで「自動マイグレーション」を実現。  
     Dockerfile  
     CMD \["sh", "-c", "npx prisma migrate deploy && node dist/index.js"\]

### **2-2. サーバー設定**

* **ファイル:** backend/src/index.ts  
* **修正内容:**  
  * port: 環境変数 PORT (Render標準は10000) を使用。  
  * hostname: '0.0.0.0' に設定（外部アクセスを受け付けるため必須）。

## **3\. フロントエンド構築手順 (Type Safety)**

バックエンドの型（Hono RPC）をフロントエンドで利用するための、最も難易度が高かった設定です。

### **3-1. パス解決と型定義 (tsconfig.json)**

バックエンドのライブラリ（Hono, Prismaなど）をフロントエンドのビルド環境で認識させるための「ハイブリッド設定」です。

* **ファイル:** frontend/tsconfig.json  
* **設定の要点:**  
  * "types": \["vite/client", "node", "react", "react-dom"\] を明記し、Reactの型落ちを防ぐ。  
  * "paths": Hono の特殊なパス構造を解決しつつ、他はワイルドカードで逃がす。  
    JSON  
    "hono": \["./node\_modules/hono"\],  
    "hono/\*": \["./node\_modules/hono/dist/\*", "./node\_modules/hono/dist/\*.d.ts"\],  
    "\*": \["./node\_modules/\*"\]

### **3-2. ビルドスクリプト (package.json)**

* **ファイル:** frontend/package.json  
* **修正内容:**  
  * ビルド前にPrismaの型生成を実行するようにスクリプトを連結。  
    "build": "prisma generate \--schema=../backend/prisma/schema.prisma && tsc && vite build"  
  * **重要:** @prisma/client と prisma のバージョンを **v5.22.0** に固定（v7系の directUrl 廃止エラーを回避）。

### **3-3. APIクライアント (client.ts)**

* **ファイル:** frontend/src/client.ts  
* **修正内容:** 環境変数から取得したURLの末尾にある /api を削除する正規化処理を追加し、URL重複（.../api/api/memos）を防止。

## **4\. 環境変数 (Security)**

機密情報はコードに書かず、Renderダッシュボードで管理します。

* **設定場所:** Render Dashboard \> Environment Groups  
* **必須項目:**  
  * DATABASE\_URL: Supabase Transaction URL  
  * DIRECT\_URL: Supabase Session URL  
  * AWS\_ENDPOINT: **https://\[ProjectID\].supabase.co/storage/v1/s3** (※ localhost禁止)  
  * AWS\_REGION: **us-east-1** (Supabase S3互換APIの仕様)  
  * AWS\_ACCESS\_KEY\_ID, AWS\_SECRET\_ACCESS\_KEY

## **5\. トラブルシューティングの教訓**

今後のために、今回発生した主なエラーとその解決策をまとめました。

| エラー現象 | 原因 | 解決策 |
| :---- | :---- | :---- |
| **Deploy Failed (Timeout)** | サーバーが localhost で起動していた、またはポートが 8080 固定だった。 | 0.0.0.0 バインドに変更し、PORT 環境変数を使用。 |
| **Cannot find module 'hono/cors'** | TypeScriptがHonoの dist 構造を認識できなかった。 | tsconfig.json の paths に hono/\* の詳細なマッピングを追加。 |
| **JSX element implicitly has type 'any'** | tsconfig の設定過剰で React の型定義が無視された。 | "types": \["react", ...\] を明記し、Reactの型を復活させた。 |
| **Prisma Error: directUrl not supported** | Prisma v7 (最新版) がインストールされ、構文エラーになった。 | package.json でバージョンを v5.22.0 に固定。 |
| **404 Not Found (.../api/api/memos)** | フロントエンドの設定と環境変数が重複してURLが不正になった。 | client.ts でURL末尾の /api を削除するロジックを追加。 |
| **画像が表示されない (Mixed Content)** | AWS\_ENDPOINT が localhost のままだった。 | ダッシュボードで Supabase の本番URL に書き換え。 |

---

このドキュメントがあれば、次回以降は迷わずに環境構築や修正ができるはずです！

次のステップ:  
F-04 メモ編集機能の実装へ進みます。準備ができたら声をかけてください。